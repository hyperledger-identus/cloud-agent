name: Performance tests

concurrency:
  group: ${{ github.head_ref }}${{ github.ref }}-performance-tests
  cancel-in-progress: true

on:
  pull_request:
    paths:
      - ".github/workflows/performance-tests.yml"
      - "tests/performance-tests/**"
  push:
    branches:
      - "main"
  workflow_dispatch:

defaults:
  run:
    shell: bash
    # working-directory: "tests/performance-tests/prism-performance-tests"
    working-directory: "tests/e2e-tests"

jobs:
  run-performance-tests:
    name: "Run performance tests"
    runs-on: self-hosted
    container:
      image: ghcr.io/input-output-hk/atala-prism-tests
      volumes:
        - /nix:/nix
      credentials:
        username: ${{ secrets.ATALA_GITHUB_ACTOR }}
        password: ${{ secrets.ATALA_GITHUB_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.ATALA_GITHUB_TOKEN }}
    services:
      db:
        image: ghcr.io/input-output-hk/postgres-multi-db
        ports:
          - 5432:5432
        env:
          POSTGRES_MULTIPLE_DATABASES: "castor_issuer,pollux_issuer,connect_issuer,iris_issuer,agent_issuer,node_db,castor_holder,pollux_holder,connect_holder,iris_holder,agent_holder"
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      prism-node:
        image: ghcr.io/input-output-hk/prism-node:v2.1.1
        env:
          NODE_PSQL_HOST: db:5432
        ports:
          - 50053:50053
      prism-agent-issuer:
        image: ghcr.io/input-output-hk/prism-agent:0.61.0
        env:
          IRIS_HOST: iris
          IRIS_PORT: 8081
          CASTOR_DB_HOST: db
          CASTOR_DB_PORT: 5432
          CASTOR_DB_NAME: castor_issuer
          CASTOR_DB_USER: postgres
          CASTOR_DB_PASSWORD: postgres
          POLLUX_DB_HOST: db
          POLLUX_DB_PORT: 5432
          POLLUX_DB_NAME: pollux_issuer
          POLLUX_DB_USER: postgres
          POLLUX_DB_PASSWORD: postgres
          CONNECT_DB_HOST: db
          CONNECT_DB_PORT: 5432
          CONNECT_DB_NAME: connect_issuer
          CONNECT_DB_USER: postgres
          CONNECT_DB_PASSWORD: postgres
          AGENT_DB_HOST: db
          AGENT_DB_PORT: 5432
          AGENT_DB_NAME: agent_issuer
          AGENT_DB_USER: postgres
          AGENT_DB_PASSWORD: postgres
          DIDCOMM_SERVICE_URL: http://prism-agent-issuer:8080/didcomm
          PRISM_NODE_HOST: prism-node
          PRISM_NODE_PORT: 50053
        ports:
          - 8080:8080
      # prism-agent-holder:
      #   image: ghcr.io/input-output-hk/prism-agent:0.61.0
      #   env:
      #     IRIS_HOST: iris
      #     IRIS_PORT: 8081
      #     CASTOR_DB_HOST: db
      #     CASTOR_DB_PORT: 5433
      #     CASTOR_DB_NAME: castor_holder
      #     CASTOR_DB_USER: postgres
      #     CASTOR_DB_PASSWORD: postgres
      #     POLLUX_DB_HOST: db
      #     POLLUX_DB_PORT: 5433
      #     POLLUX_DB_NAME: pollux_holder
      #     POLLUX_DB_USER: postgres
      #     POLLUX_DB_PASSWORD: postgres
      #     CONNECT_DB_HOST: db
      #     CONNECT_DB_PORT: 5433
      #     CONNECT_DB_NAME: connect_holder
      #     CONNECT_DB_USER: postgres
      #     CONNECT_DB_PASSWORD: postgres
      #     AGENT_DB_HOST: db
      #     AGENT_DB_PORT: 5433
      #     AGENT_DB_NAME: agent_holder
      #     AGENT_DB_USER: postgres
      #     AGENT_DB_PASSWORD: postgres
      #     DIDCOMM_SERVICE_URL: http://prism-agent-holder:8090/didcomm
      #     PRISM_NODE_HOST: prism-node
      #     PRISM_NODE_PORT: 50053
      #   ports:
      #     - 8090:8090
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # - name: Login to GitHub Container Registry
      #   uses: docker/login-action@v2
      #   with:
      #     registry: ghcr.io
      #     username: ${{ secrets.ATALA_GITHUB_ACTOR }}
      #     password: ${{ secrets.ATALA_GITHUB_TOKEN }}

      # - name: Start services for issuer
      #   env:
      #     PORT: 8080
      #   uses: isbang/compose-action@v1.4.1
      #   with:
      #     compose-file: "./infrastructure/shared/docker-compose.yml"
      #     compose-flags: "--env-file ./infrastructure/local/.env -p issuer"
      #     up-flags: "--wait"
      #     down-flags: "--volumes"

      # - name: Start services for holder
      #   env:
      #     PORT: 8090
      #   uses: isbang/compose-action@v1.4.1
      #   with:
      #     compose-file: "./infrastructure/shared/docker-compose.yml"
      #     compose-flags: "--env-file ./infrastructure/local/.env -p holder"
      #     up-flags: "--wait"
      #     down-flags: "--volumes"

      - name: Run performance tests
        run: |
          export ACME_AGENT_URL="http://prism-agent-issuer:8080"
          export BOB_AGENT_URL="http://prism-agent-holder:8090"
          sleep 20
          curl -v prism-agent-issuer:8080/connections
          # ./gradlew test --tests "E2eTestsRunner" -Dcucumber.filter.tags="@TEST_ATL-3834"

      # - uses: actions/upload-artifact@v2
      #   with:
      #     name: performance-tests-results
      #     path: tests/performance-tests/prism-performance-tests/build/reports
