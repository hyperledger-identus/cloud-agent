name: Performance tests

concurrency:
  group: ${{ github.head_ref }}${{ github.ref }}-performance-tests
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches:
      - "main"
  workflow_dispatch:

defaults:
  run:
    shell: bash
    working-directory: "tests/performance-tests/atala-performance-tests-k6"

jobs:
  run-e2e-tests:
    name: "Run performance tests"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Java and Scala
        uses: olafurpg/setup-scala@v13
        with:
          java-version: openjdk@1.11

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ secrets.ATALA_GITHUB_ACTOR }}
          password: ${{ secrets.ATALA_GITHUB_TOKEN }}

      - name: Install Compose
        uses: ndeloof/install-compose-action@v0.0.1
        with:
          version: v2.12.2
          legacy: true    # will also install in PATH as `docker-compose`

#      - name: Build local version of PRISM Agent
#        env:
#          ENV_FILE: "infrastructure/local/.env"
#          PRISM_AGENT_PATH: "../../.."
#          GITHUB_ACTOR: ${{ secrets.ATALA_GITHUB_ACTOR }}
#          GITHUB_TOKEN: ${{ secrets.ATALA_GITHUB_TOKEN }}
#        run: |
#          cd "${PRISM_AGENT_PATH}" || exit 129
#          sbt docker:publishLocal
#          PRISM_AGENT_VERSION=$(cut version.sbt -d '=' -f2 | tr -d '" ')
#          sed -i.bak "s/PRISM_AGENT_VERSION=.*/PRISM_AGENT_VERSION=${PRISM_AGENT_VERSION}/" "${ENV_FILE}" && rm -f "${ENV_FILE}.bak"
#          cat "${ENV_FILE}"

      - name: Start services for issuer
        env:
          PORT: 8080
        uses: isbang/compose-action@v1.4.1
        with:
          compose-file: "./infrastructure/shared/docker-compose.yml"
          compose-flags: "--env-file ./infrastructure/local/.env -p issuer"
          up-flags: "--wait"
          down-flags: "--volumes"

      - name: Start services for holder
        env:
          PORT: 8090
        uses: isbang/compose-action@v1.4.1
        with:
          compose-file: "./infrastructure/shared/docker-compose.yml"
          compose-flags: "--env-file ./infrastructure/local/.env -p holder"
          up-flags: "--wait"
          down-flags: "--volumes"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      - name: Compile tests to JS
        uses: borales/actions-yarn@v4
        with:
          cmd: install

      - name: Compile tests to JS
        uses: borales/actions-yarn@v4
        with:
          cmd: webpack

      - name: Run k6
        uses: grafana/k6-action@v0.3.0
        with:
          filename: "./dist/connection-flow-test.js"
