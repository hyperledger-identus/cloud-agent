name: Performance tests

concurrency:
  group: ${{ github.head_ref }}${{ github.ref }}-performance-tests
  cancel-in-progress: true

on:
  pull_request:
    paths:
      - ".github/workflows/performance-tests.yml"
      - "tests/performance-tests/**"
  push:
    branches:
      - "main"
  workflow_dispatch:

defaults:
  run:
    shell: bash
    working-directory: "tests/performance-tests/prism-performance-tests"

jobs:
  run-performance-tests:
    name: "Run performance tests"
    runs-on: self-hosted
    container:
      image: ghcr.io/input-output-hk/atala-prism-tests
      volumes:
        - /nix:/nix
      credentials:
        username: ${{ secrets.ATALA_GITHUB_ACTOR }}
        password: ${{ secrets.ATALA_GITHUB_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.ATALA_GITHUB_TOKEN }}
    services:
      db:
        image: ghcr.io/input-output-hk/postgres-multi-db@sha256:f2786dcfabc34d752586fcc92db4187f22f5e130ca07dbc761db0e9b83a0de82
        ports:
          - 5432:5432
        env:
          POSTGRES_MULTIPLE_DATABASES: "castor,pollux,connect,iris,agent,node_db"
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      prism-agent:
        image: ghcr.io/input-output-hk/prism-agent:0.61.0
        env:
          IRIS_HOST: iris
          IRIS_PORT: 8081
          CASTOR_DB_HOST: db
          CASTOR_DB_PORT: 5432
          CASTOR_DB_NAME: castor
          CASTOR_DB_USER: postgres
          CASTOR_DB_PASSWORD: postgres
          POLLUX_DB_HOST: db
          POLLUX_DB_PORT: 5432
          POLLUX_DB_NAME: pollux
          POLLUX_DB_USER: postgres
          POLLUX_DB_PASSWORD: postgres
          CONNECT_DB_HOST: db
          CONNECT_DB_PORT: 5432
          CONNECT_DB_NAME: connect
          CONNECT_DB_USER: postgres
          CONNECT_DB_PASSWORD: postgres
          AGENT_DB_HOST: db
          AGENT_DB_PORT: 5432
          AGENT_DB_NAME: agent
          AGENT_DB_USER: postgres
          AGENT_DB_PASSWORD: postgres
          DIDCOMM_SERVICE_URL: http://host.docker.internal:${PORT}/didcomm
          PRISM_NODE_HOST: prism-node
          PRISM_NODE_PORT: 50053
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # - name: Login to GitHub Container Registry
      #   uses: docker/login-action@v2
      #   with:
      #     registry: ghcr.io
      #     username: ${{ secrets.ATALA_GITHUB_ACTOR }}
      #     password: ${{ secrets.ATALA_GITHUB_TOKEN }}

      # - name: Start services for issuer
      #   env:
      #     PORT: 8080
      #   uses: isbang/compose-action@v1.4.1
      #   with:
      #     compose-file: "./infrastructure/shared/docker-compose.yml"
      #     compose-flags: "--env-file ./infrastructure/local/.env -p issuer"
      #     up-flags: "--wait"
      #     down-flags: "--volumes"

      # - name: Start services for holder
      #   env:
      #     PORT: 8090
      #   uses: isbang/compose-action@v1.4.1
      #   with:
      #     compose-file: "./infrastructure/shared/docker-compose.yml"
      #     compose-flags: "--env-file ./infrastructure/local/.env -p holder"
      #     up-flags: "--wait"
      #     down-flags: "--volumes"

      # - name: Run performance tests
      #   run: |
      #     ./gradlew gatlingRun

      # - uses: actions/upload-artifact@v2
      #   with:
      #     name: performance-tests-results
      #     path: tests/performance-tests/prism-performance-tests/build/reports