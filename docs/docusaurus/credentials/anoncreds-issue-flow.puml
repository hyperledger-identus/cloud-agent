@startuml
title Issue flow - AnonCreds

actor Holder as holder
participant VDR
participant "Holder PRISM Agent" as holderAgent
participant "Issuer PRISM Agent" as issuerAgent
actor Issuer as issuer

note over holderAgent, issuerAgent #aqua
    It is assumed that a connection already exists between the holder and the issuer, and that they both have an existing Prism DID.
    It is also assumed that AnonCreds related setup is completed (credential definition object published and holder has link secret generated).
end note
|||
== Create and send credential offer ==
|||
issuer -> issuerAgent: Create new credential offer\n""POST /issue-credentials/credential-offers""\n""{connectionId, claims, issuingDID}""
issuerAgent -> issuerAgent: Create issue credential state record
issuerAgent --> issuer: Issue credential record {id, state}
note over issuerAgent: state=OfferPending
|||

== Send credential offer over DIDComm ==
|||
issuerAgent -> holderAgent: ""CredentialOffer"" message (includes domain/challenge)
holderAgent -> holderAgent: Create issue credential state record
holderAgent --> issuerAgent: OK
note over holderAgent: state=OfferReceived
/ note over issuerAgent: state=OfferSent
|||

== Verify received credential offer (AC) ==
|||
holderAgent -> VDR: Retrieve Schema
holderAgent -> VDR: Retrieve Credential Definition
holderAgent -> holderAgent: Verify received credential offer
|||

== Review and accept credential offer ==
|||
holder -> holderAgent: Retrieve credential records\n""GET /issue-credentials/records""
holderAgent --> holder: record list
|||
holder -> holderAgent: Accept credential offer\n""POST /issue-credentials/records/{id}/accept-offer""\n""{subjectId=did:prism:xxx}""
note right #pink: Here the holder specifies the subject DID\nto which the credential should be issued \n**IS THIS RELEVANT TO AC??? HOLDER'S DID NOT USED IN AC FLOW**
holderAgent --> holder: OK
note over holderAgent: state=RequestPending
|||

== Generate and send credential request ==
|||
holderAgent -> holderAgent: Sign the domain/challenge received from\nthe issuer with subject Prism DID (**CA: not used**)
holderAgent -> holderAgent: Create credential request (input: offer, CD, link secret, entropy/did)
note over holderAgent: state=RequestGenerated
|||
holderAgent -> issuerAgent: RequestCredential message (with DID ownership proof)
issuerAgent --> holderAgent: OK
note over holderAgent: state=RequestSent
/ note over issuerAgent: state=RequestReceived
|||

== Generate and send credential ==
|||
alt automaticIssuance=true
issuerAgent -> issuerAgent: Automatically approve credential request
else automaticIssuance=false
issuer -> issuerAgent: Explicitly approve credential request\n""POST /issue-credentials/records/{id}/issue-credential""
end
note over issuerAgent: state=CredentialPending
|||
issuerAgent -> issuerAgent: Generate credential signed with Issuing Prism DID and\nissued to Subject Prism DID
note over issuerAgent: state=CredentialGenerated
|||
issuerAgent -> holderAgent: ""IssueCredential"" message (includes JWT credential)
holderAgent --> issuerAgent: OK
note over issuerAgent: state=CredentialSent
/ note over holderAgent: state=CredentialReceived
|||
@enduml
